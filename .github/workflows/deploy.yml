name: Deploy to Fly.io

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Generate app name from GitHub username
        id: app-name
        run: |
          # èŽ·å– GitHub ç”¨æˆ·åå¹¶è½¬å°å†™
          GITHUB_USERNAME=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          # ä½¿ç”¨æˆªæ–­çš„ç”¨æˆ·åï¼ˆæœ€å¤§16å­—ç¬¦ï¼‰ç”Ÿæˆåº”ç”¨åç§°
          # å› ä¸º Fly.io åº”ç”¨åæœ€å¤§é•¿åº¦æœ‰é™åˆ¶
          SHORT_USERNAME=$(echo $GITHUB_USERNAME | cut -c1-16)
          APP_NAME="poe-proxy-${SHORT_USERNAME}"
          # è¾“å‡ºåº”ç”¨åç§°
          echo "App name: $APP_NAME"
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT

      - name: Generate fly.toml
        run: |
          cat > fly.toml << 'EOL'
          app = '${{ steps.app-name.outputs.app_name }}'
          primary_region = 'hkg'

          [build]

          [http_service]
            internal_port = 8080
            force_https = true
            auto_stop_machines = true
            auto_start_machines = true
            min_machines_running = 0
            processes = ['app']

          [[vm]]
            memory = '512mb'
            cpu_kind = 'shared'
            cpus = 1
          EOL
          
          cat fly.toml

      - name: Check if app exists or create it
        run: |
          if flyctl apps list | grep -q ${{ steps.app-name.outputs.app_name }}; then
            echo "App ${{ steps.app-name.outputs.app_name }} already exists"
          else
            echo "Creating new app ${{ steps.app-name.outputs.app_name }}"
            flyctl apps create ${{ steps.app-name.outputs.app_name }}
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Configure Fly.io Secrets
        run: |
          # è®¾ç½® POE API å¯†é’¥
          if [ -n "${{ secrets.POE_API_KEYS }}" ]; then
            flyctl secrets set POE_API_KEYS="${{ secrets.POE_API_KEYS }}" --app ${{ steps.app-name.outputs.app_name }}
          fi
          
          # è®¾ç½®è®¿é—®ä»¤ç‰Œ
          if [ -n "${{ secrets.ACCESS_TOKENS }}" ]; then
            flyctl secrets set ACCESS_TOKENS="${{ secrets.ACCESS_TOKENS }}" --app ${{ steps.app-name.outputs.app_name }}
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only --app ${{ steps.app-name.outputs.app_name }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Display app URL
        run: |
          echo "================================================="
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "ðŸŒ åº”ç”¨ URL: https://${{ steps.app-name.outputs.app_name }}.fly.dev"
          echo "================================================="
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}