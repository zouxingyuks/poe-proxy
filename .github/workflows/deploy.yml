name: Deploy to Fly.io

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Generate app name from GitHub username
        id: app-name
        run: |
          # è·å– GitHub ç”¨æˆ·åå¹¶è½¬å°å†™
          GITHUB_USERNAME=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          # ä½¿ç”¨æˆªæ–­çš„ç”¨æˆ·åï¼ˆæœ€å¤§16å­—ç¬¦ï¼‰ç”Ÿæˆåº”ç”¨åç§°
          SHORT_USERNAME=$(echo $GITHUB_USERNAME | cut -c1-16)
          APP_NAME="poe-proxy-${SHORT_USERNAME}"
          echo "App name: $APP_NAME"
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT

      - name: Generate fly.toml
        run: |
          cat > fly.toml << 'EOL'
          app = '${{ steps.app-name.outputs.app_name }}'
          primary_region = 'hkg'

          [build]

          [http_service]
            internal_port = 8080
            force_https = true
            auto_stop_machines = true
            auto_start_machines = true
            min_machines_running = 0
            processes = ['app']

          [[vm]]
            memory = '512mb'
            cpu_kind = 'shared'
            cpus = 1
          EOL
          
          cat fly.toml

      - name: Check if app exists or create it
        id: check-app
        run: |
          if flyctl apps list | grep -q ${{ steps.app-name.outputs.app_name }}; then
            echo "App ${{ steps.app-name.outputs.app_name }} already exists"
            echo "app_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Creating new app ${{ steps.app-name.outputs.app_name }}"
            flyctl apps create ${{ steps.app-name.outputs.app_name }}
            echo "app_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Configure Fly.io Secrets
        run: |
          # è®¾ç½® POE API å¯†é’¥
          if [ -n "${{ secrets.POE_API_KEYS }}" ]; then
            flyctl secrets set POE_API_KEYS="${{ secrets.POE_API_KEYS }}" --app ${{ steps.app-name.outputs.app_name }}
          fi
          
          # è®¾ç½®è®¿é—®ä»¤ç‰Œ
          if [ -n "${{ secrets.ACCESS_TOKENS }}" ]; then
            flyctl secrets set ACCESS_TOKENS="${{ secrets.ACCESS_TOKENS }}" --app ${{ steps.app-name.outputs.app_name }}
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only --app ${{ steps.app-name.outputs.app_name }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Configure custom domain (if provided)
        if: ${{ vars.CUSTOM_DOMAIN != '' }}
        id: custom-domain
        run: |
          echo "Setting up custom domain: ${{ vars.CUSTOM_DOMAIN }}"
          
          # æ£€æŸ¥åŸŸåæ˜¯å¦å·²æ·»åŠ 
          if flyctl domains list --app ${{ steps.app-name.outputs.app_name }} | grep -q "${{ vars.CUSTOM_DOMAIN }}"; then
            echo "Domain already registered, checking certificate status..."
          else
            # æ·»åŠ è‡ªå®šä¹‰åŸŸå
            flyctl domains add ${{ vars.CUSTOM_DOMAIN }} --app ${{ steps.app-name.outputs.app_name }}
          fi
          
          # å­˜å‚¨åŸŸåä¿¡æ¯
          echo "custom_domain=${{ vars.CUSTOM_DOMAIN }}" >> $GITHUB_OUTPUT
          
          # è·å–åŸŸåéªŒè¯ä¿¡æ¯
          DOMAIN_INFO=$(flyctl domains list --app ${{ steps.app-name.outputs.app_name }} --json | jq '.[] | select(.name=="${{ vars.CUSTOM_DOMAIN }}")')
          echo "domain_info=$DOMAIN_INFO" >> $GITHUB_OUTPUT
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Display app information
        run: |
          echo "================================================="
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ åº”ç”¨ URL: https://${{ steps.app-name.outputs.app_name }}.fly.dev"
          
          if [ -n "${{ steps.custom-domain.outputs.custom_domain }}" ]; then
            echo ""
            echo "ğŸ”’ è‡ªå®šä¹‰åŸŸåè®¾ç½®"
            echo "åŸŸå: ${{ steps.custom-domain.outputs.custom_domain }}"
            echo ""
            echo "ğŸ“ DNS é…ç½®è¯´æ˜:"
            echo "1. ç™»å½• Fly.io æ§åˆ¶å°: https://fly.io/dashboard"
            echo "2. é€‰æ‹©åº”ç”¨: ${{ steps.app-name.outputs.app_name }}"
            echo "3. è¿›å…¥ 'Certificates' æ ‡ç­¾æŸ¥çœ‹åŸŸåçŠ¶æ€"
            echo "4. æŒ‰ç…§ç•Œé¢ä¸Šçš„æŒ‡ç¤ºæ·»åŠ å¿…è¦çš„ DNS è®°å½•"
            echo ""
            echo "é€šå¸¸ï¼Œæ‚¨éœ€è¦æ·»åŠ ä¸€æ¡ CNAME è®°å½•æŒ‡å‘:"
            echo "${{ steps.app-name.outputs.app_name }}.fly.dev"
          fi
          echo "================================================="
          
          echo "ä¸€æ—¦ DNS é…ç½®ç”Ÿæ•ˆï¼ˆè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶ï¼‰ï¼Œæ‚¨å°±å¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®æ‚¨çš„æœåŠ¡:"
          echo "https://${{ steps.custom-domain.outputs.custom_domain }}"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}